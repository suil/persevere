# Insert Delete GetRandom O(1) - Duplicates allowed
[381. Insert Delete GetRandom O(1) - Duplicates allowed](https://leetcode.com/problems/insert-delete-getrandom-o1-duplicates-allowed/)

RandomizedCollection is a data structure that contains a collection of numbers, possibly duplicates (i.e., a multiset). It should support inserting and removing specific elements and also reporting a random element.

# Key insights
- Use an array for O(1) random access and a Map of value -> Set of indices
- Insert: add to end of array, add index to the value's set
- Remove: swap target with last element, update indices in the map, pop last
- Handle edge case when removing the last element (don't update index twice)

# Code
```javascript

var RandomizedCollection = function() {
    this.values = [];
    this.store = new Map(); // val => Set(index1, index2)
};

/** 
 * @param {number} val
 * @return {boolean}
 */
RandomizedCollection.prototype.insert = function(val) {
    const existed = this.store.has(val);
    
    if (!existed) {
        this.store.set(val, new Set());
    }

    this.store.get(val).add(this.values.length);
    this.values.push(val);

    return !existed;
};

/** 
 * @param {number} val
 * @return {boolean}
 */
RandomizedCollection.prototype.remove = function(val) {
    if (!this.store.has(val)) return false;

    // values[..., val, ..., lastElement]
    // map ( val => Set(removeIndex, ...)
    //.      lastElement => Set(...lastElementIndex))
    // values[..., lastElement, ....]
    // map ( val => Set(...), lastElement => Set(..., valIndex))

    const removeIndex = this.store.get(val).values().next().value;
    const lastVal = this.values.at(-1);
    const lastValIndex = this.values.length - 1;

    this.values[removeIndex] = lastVal;
    this.values.pop();

    this.store.get(val).delete(removeIndex);
    if (this.store.get(val).size === 0) {
        this.store.delete(val);
    }

    if (removeIndex !== lastValIndex) {
        this.store.get(lastVal).delete(lastValIndex)
        this.store.get(lastVal).add(removeIndex);
    }

    return true;
};

/**
 * @return {number}
 */
RandomizedCollection.prototype.getRandom = function() {
    const index = Math.floor(Math.random() * this.values.length);
    return this.values[index];
};

/** 
 * Your RandomizedCollection object will be instantiated and called as such:
 * var obj = new RandomizedCollection()
 * var param_1 = obj.insert(val)
 * var param_2 = obj.remove(val)
 * var param_3 = obj.getRandom()
 */
```

# Complexity
**Time:** O(1) average for insert, remove, and getRandom
**Space:** O(n) - for storing values and index sets
